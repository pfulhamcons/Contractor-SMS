<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visitor & Contractor Safety Management System</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .burgundy-bg { background-color: #800020; }
    .burgundy-text { color: #800020; }
    .burgundy-border { border-color: #800020; }
    .burgundy-hover:hover { background-color: #660019; }
    .burgundy-light { color: #ffcccb; }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // ============================================
    // CONFIGURATION - CHANGE THESE VALUES
    // ============================================
    const LOGO_FILE = 'osi-group-logo-vector.png';
    const COMPANY_NAME = 'West Chicago';
    const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxgQtWZPS08jaXRsNNva85tuQmd3Zs8HdhUB0ZgJpR_Nv_GWmTMLoZO4ncrLwdPMduH/exec';
    const REQUIRED_AGREEMENT_DOC = 'documents/Visitor-Contractor GMP PDF Sign Off Rev 01_7-19-24.pdf';
    // ============================================

    // Icons (simplified)
    const UserIcon = () => (
      <svg className="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
    );
    const CheckCircleIcon = () => (
      <svg className="inline w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );
    const AlertTriangleIcon = () => (
      <svg className="inline w-5 h-5 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
    );

    function ContractorSafetySystem() {
      const [activeTab, setActiveTab] = useState('signin');
      const [signInData, setSignInData] = useState({ name: '', company: '', companyHost: '', visitType: '', purpose: '', date: new Date().toISOString().split('T')[0] });
      const [checkOutName, setCheckOutName] = useState('');
      const [agreementSigned, setAgreementSigned] = useState(false);
      const [signature, setSignature] = useState('');
      const [agreementOpened, setAgreementOpened] = useState(false);
      const [agreementScrolled, setAgreementScrolled] = useState(false);
      const [agreementConfirmed, setAgreementConfirmed] = useState(false);
      const [visitors, setVisitors] = useState([]);
      const [evacList, setEvacList] = useState([]);
      const [isSaving, setIsSaving] = useState(false);
      const [isLoadingEvac, setIsLoadingEvac] = useState(false);
      const agreementBoxRef = useRef(null);

      const toMDYYYY = (dateObj) => dateObj.toLocaleDateString('en-US');
      const todayMDYYYY = toMDYYYY(new Date());

      // -----------------------------
      // GOOGLE SHEETS SAVE
      // -----------------------------
      const saveToGoogleSheets = async (data, action='checkin') => {
        try {
          const params = new URLSearchParams({
            action,
            name: data.name || '',
            company: data.company || '',
            companyHost: data.companyHost || '',
            visitType: data.visitType || '',
            purpose: data.purpose || '',
            date: data.date || '',
            checkInTime: data.checkInTime || '',
            checkOutTime: data.checkOutTime || ''
          });
          const url = `${GOOGLE_SHEET_URL}?${params.toString()}`;
          const res = await fetch(url, { method: 'GET', redirect: 'follow' });
          const result = await res.text();
          console.log('Google Sheets Response:', result);
          return true;
        } catch (err) {
          console.error('Error sending to Google Sheets:', err);
          return false;
        }
      };

      // -----------------------------
      // FETCH VISITORS TODAY ONLY
      // -----------------------------
      const fetchVisitors = async () => {
        try {
          const url = `${GOOGLE_SHEET_URL}?action=getvisitors`;
          const res = await fetch(url);
          const data = await res.json();

          if (data.status === "success" && Array.isArray(data.visitors)) {
            const filtered = data.visitors.filter(v => (v.date || "").trim() === todayMDYYYY);
            setVisitors(filtered);
          } else setVisitors([]);
        } catch (err) {
          console.error('Failed to fetch visitors:', err);
          setVisitors([]);
        }
      };

      // -----------------------------
      // FETCH EVACUATION LIST
      // -----------------------------
      const fetchEvacuationList = async () => {
        try {
          setIsLoadingEvac(true);
          const url = `${GOOGLE_SHEET_URL}?action=getvisitors`;
          const res = await fetch(url);
          const data = await res.json();

          if (data.status === "success" && Array.isArray(data.visitors)) {
            const filtered = data.visitors.filter(v => (v.date || "").trim() === todayMDYYYY);
            setEvacList(filtered);
          } else setEvacList([]);
        } catch (err) {
          console.error('Failed to fetch evacuation list:', err);
          setEvacList([]);
        } finally {
          setIsLoadingEvac(false);
        }
      };

      useEffect(() => {
        if (activeTab === "evacuation") fetchEvacuationList();
        if (activeTab === "visitors") fetchVisitors();
      }, [activeTab]);

      // -----------------------------
      // HANDLERS
      // -----------------------------
      const handleSignIn = async () => {
        if (!agreementSigned) {
          alert('Please sign the safety agreement before checking in.');
          setActiveTab('agreement'); return;
        }
        if (!signInData.name || !signInData.company || !signInData.companyHost || !signInData.visitType || !signInData.purpose) {
          alert('Please fill in all required fields'); return;
        }
        setIsSaving(true);
        const dataToSend = { ...signInData, checkInTime: new Date().toLocaleTimeString(), date: new Date().toLocaleDateString() };
        await saveToGoogleSheets(dataToSend, 'checkin');
        setIsSaving(false);
        alert(`Check-in successful!\n\n${signInData.name} from ${signInData.company} has been logged.`);
        setSignInData({ name:'', company:'', companyHost:'', visitType:'', purpose:'', date:new Date().toISOString().split('T')[0] });
        setAgreementSigned(false); setSignature(''); setAgreementOpened(false); setAgreementScrolled(false); setAgreementConfirmed(false);
      };

      const handleCheckOut = async () => {
        if (!checkOutName.trim()) { alert('Please enter your name'); return; }
        setIsSaving(true);
        await saveToGoogleSheets({ name: checkOutName, date: new Date().toLocaleDateString(), checkOutTime: new Date().toLocaleTimeString() }, 'checkout');
        setIsSaving(false);
        alert(`Check-out successful!\n\n${checkOutName} has been logged out.`);
        setCheckOutName('');
      };

      const handleAgreementSign = () => {
        if (!agreementOpened || !agreementScrolled || !agreementConfirmed || signature.trim().length < 3) {
          alert('Please complete all steps to sign the agreement'); return;
        }
        setAgreementSigned(true);
        alert('Agreement signed successfully! You can now check in.');
        setActiveTab('signin');
      };

      const handleDownload = (file) => {
        window.open(file, '_blank');
        if (file === REQUIRED_AGREEMENT_DOC) setAgreementOpened(true);
      };

      const handleAgreementScroll = () => {
        const el = agreementBoxRef.current;
        if (!el) return;
        if (el.scrollTop + el.clientHeight >= el.scrollHeight - 10) setAgreementScrolled(true);
      };

      const handlePrintEvacuation = () => window.print();

      const canSignAgreement = agreementOpened && agreementScrolled && agreementConfirmed && signature.trim().length >=3;

      const documents = [{ name: 'Visitor/Contractor Agreement', file: REQUIRED_AGREEMENT_DOC, category: 'Safety' }];

      // -----------------------------
      // RENDER
      // -----------------------------
      return (
        <div className="min-h-screen bg-gray-50">
          <div className="burgundy-bg text-white py-6 px-4 shadow-lg">
            <div className="max-w-6xl mx-auto flex items-center">
              <img src={LOGO_FILE} alt="Company Logo" className="h-16 w-auto mr-4 object-contain" onError={e=>{e.target.style.display='none'}}/>
              <div>
                <h1 className="text-3xl font-bold">{COMPANY_NAME}</h1>
                <p className="burgundy-light mt-1">Visitor & Contractor Safety Management System</p>
              </div>
            </div>
          </div>

          <div className="bg-white shadow">
            <div className="max-w-6xl mx-auto px-4 flex flex-wrap">
              <button onClick={()=>setActiveTab('signin')} className={`px-4 py-4 font-medium ${activeTab==='signin'?'burgundy-text border-b-2 burgundy-border':'text-gray-600 hover:text-gray-900'}`}>Check In</button>
              <button onClick={()=>setActiveTab('checkout')} className={`px-4 py-4 font-medium ${activeTab==='checkout'?'burgundy-text border-b-2 burgundy-border':'text-gray-600 hover:text-gray-900'}`}>Check Out</button>
              <button onClick={()=>setActiveTab('agreement')} className={`px-4 py-4 font-medium ${activeTab==='agreement'?'burgundy-text border-b-2 burgundy-border':'text-gray-600 hover:text-gray-900'}`}>Agreement</button>
              <button onClick={()=>setActiveTab('documents')} className={`px-4 py-4 font-medium ${activeTab==='documents'?'burgundy-text border-b-2 burgundy-border':'text-gray-600 hover:text-gray-900'}`}>Documents</button>
              <button onClick={()=>setActiveTab('visitors')} className={`px-4 py-4 font-medium ${activeTab==='visitors'?'burgundy-text border-b-2 burgundy-border':'text-gray-600 hover:text-gray-900'}`}>Visitors</button>
              <button onClick={()=>setActiveTab('evacuation')} className={`px-4 py-4 font-medium ${activeTab==='evacuation'?'burgundy-text border-b-2 burgundy-border':'text-gray-600 hover:text-gray-900'}`}>Evacuation Roll Call</button>
            </div>
          </div>

          <div className="max-w-6xl mx-auto px-4 py-8">
            {/* Visitors tab */}
            {activeTab==='visitors' && (
              <div className="bg-white rounded-lg shadow-md p-6">
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
                  <h2 className="text-2xl font-bold text-gray-900">Current Visitors</h2>
                  <button onClick={fetchVisitors} className="px-4 py-2 burgundy-bg text-white rounded burgundy-hover transition-colors">Refresh</button>
                </div>

                {visitors.length===0 ? (
                  <div className="text-center py-12 text-gray-500">
                    <UserIcon />
                    <p>No visitors checked in today</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {visitors.map((visitor,i)=>(
                      <div key={i} className="p-4 border border-gray-200 rounded-lg">
                        <div className="flex flex-col md:flex-row justify-between items-start">
                          <div className="mb-2 md:mb-0">
                            <h3 className="font-medium text-gray-900">{visitor.name}</h3>
                            <p className="text-sm text-gray-600">{visitor.company}</p>
                            <p className="text-sm text-gray-500 mt-1">{visitor.purpose}</p>
                          </div>
                          <div className="text-left md:text-right">
                            <p className="text-sm font-medium text-gray-900">{visitor.checkInTime}</p>
                            <p className="text-sm text-gray-500">{visitor.date}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Evacuation, Agreement, SignIn, CheckOut, Documents tabs... 
                Keep your existing code here for those tabs (same as before)
            */}
          </div>
        </div>
      );
    }

    ReactDOM.render(<ContractorSafetySystem />, document.getElementById('root'));
  </script>
</body>
</html>
